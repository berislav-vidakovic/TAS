image: docker:24

services:
  - docker:24-dind

stages:
  - build
  - test

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

# ---------------- Build staging Docker image ----------------
build_staging_env:
  stage: build
  script:
    - echo "Frontend artifacts are automatically received from SUT pipeline"
    # GitLab automatically forwards artifacts from SUT pipeline when using `trigger: strategy: depend`
    # Dockerfile expects webshop/dist/ to exist, which is now present
    - docker build -t webshop-staging-tas .
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'  # only runs when triggered by SUT

# ---------------- Run TAS tests inside container ----------------
run_tas_in_container:
  stage: test
  dependencies:
    - build_staging_env
  script:
    - echo "Running staging container with TAS tests..."
    # This will start Nginx + mvn test as per your Dockerfile CMD
    - docker run --rm webshop-staging-tas
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'
